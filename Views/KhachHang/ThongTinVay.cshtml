@model VAYTIEN.Models.ThongTinVayViewModel

<h2 class="text-primary">Th√¥ng Tin T·∫•t C·∫£ H·ª£p ƒê·ªìng Vay</h2>
<p class="alert alert-info">
    <strong>T·ªïng s·ªë ti·ªÅn ƒë√£ vay:</strong> @Model.TongSoTienVay.ToString("N0") VNƒê
</p>

@foreach (var hd in Model.HopDongs)
{
    <div class="card mb-4">
        <div class="card-header bg-secondary text-white">
            <strong>H·ª£p ƒë·ªìng #@hd.MaHopDong</strong> ‚Äî @hd.SoTienVay?.ToString("N0") VNƒê
        </div>
        <div class="card-body">
            <p><strong>Th·ªùi gian vay:</strong> @hd.NgayVay?.ToString("dd/MM/yyyy") ‚Üí @hd.NgayHetHan?.ToString("dd/MM/yyyy")</p>

            @{
                var lichTraTam = hd.LichTra ?? new List<VAYTIEN.Models.LichTraViewModel>();

                if (!lichTraTam.Any() && hd.NgayVay.HasValue && hd.NgayHetHan.HasValue && hd.SoTienVay.HasValue)
                {
                    var kyHan = (hd.NgayHetHan.Value.Year - hd.NgayVay.Value.Year) * 12 + hd.NgayHetHan.Value.Month - hd.NgayVay.Value.Month;
                    var ngayTra = hd.NgayVay.Value;
                    var tienMoiThang = Math.Round(hd.SoTienVay.Value / kyHan, 0);

                    for (int i = 1; i <= kyHan; i++)
                    {
                        lichTraTam.Add(new VAYTIEN.Models.LichTraViewModel
                        {
                            KyHanThu = i,
                            NgayTra = ngayTra.AddMonths(i),
                            SoTienPhaiTra = tienMoiThang,
                            TrangThai = "Ch∆∞a c√≥ d·ªØ li·ªáu"
                        });
                    }
                }

                var kyCanThanhToan = lichTraTam
                .Where(x => (x.TrangThai == "Ch∆∞a tr·∫£" || x.TrangThai == "Ch∆∞a c√≥ d·ªØ li·ªáu") && x.NgayTra.HasValue)
                .FirstOrDefault();
            }

            @if (kyCanThanhToan != null)
            {
                <div class="mb-3 p-2 border rounded bg-light">
                    <strong>üîî Th√°ng c·∫ßn thanh to√°n:</strong> @kyCanThanhToan.NgayTra?.ToString("MM/yyyy") ‚Äî
                    <strong>S·ªë ti·ªÅn:</strong> @kyCanThanhToan.SoTienPhaiTra?.ToString("N0") VNƒê

                    <form method="post" asp-controller="ThanhToan" asp-action="ChiTiet" class="d-inline ms-3">
                        <input type="hidden" name="MaHopDong" value="@hd.MaHopDong" />
                        <input type="hidden" name="KyHan" value="@kyCanThanhToan.KyHanThu" />
                        <button type="submit" class="btn btn-sm btn-success">Thanh to√°n k·ª≥ n√†y</button>
                    </form>
                </div>
            }

            <table class="table table-bordered">
                <thead class="table-light">
                    <tr>
                        <th>K·ª≥ h·∫°n</th>
                        <th>Ng√†y tr·∫£</th>
                        <th>S·ªë ti·ªÅn</th>
                        <th>Tr·∫°ng th√°i</th>
                        <th>Thanh to√°n</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in lichTraTam)
                    {
                        var isChuaTra = item.TrangThai == "Ch∆∞a tr·∫£" || item.TrangThai == "Ch∆∞a c√≥ d·ªØ li·ªáu";

                        <tr>
                            <td>@item.KyHanThu</td>
                            <td>@item.NgayTra?.ToString("dd/MM/yyyy")</td>
                            <td>@item.SoTienPhaiTra?.ToString("N0") VNƒê</td>
                            <td>
                                @if (item.TrangThai == "ƒê√£ tr·∫£")
                                {
                                    <span class="badge bg-success">ƒê√£ tr·∫£</span>
                                }
                                else if (item.TrangThai == "Ch∆∞a tr·∫£")
                                {
                                    <span class="badge bg-warning text-dark">Ch∆∞a tr·∫£</span>
                                }
                                else if (item.TrangThai == "Ch∆∞a c√≥ d·ªØ li·ªáu")
                                {
                                    <span class="badge bg-secondary">Ch∆∞a c√≥ d·ªØ li·ªáu</span>
                                }
                                else
                                {
                                    <span class="badge bg-dark text-white">@item.TrangThai</span>
                                }
                            </td>
                            <td>
                                @if (isChuaTra)
                                {
                                    <form method="get" asp-controller="ThanhToan" asp-action="ChiTiet">
                                        <input type="hidden" name="maHopDong" value="@hd.MaHopDong" />
                                        <input type="hidden" name="kyHanThu" value="@item.KyHanThu" />
                                        <button type="submit" class="btn btn-sm btn-danger">Thanh to√°n</button>
                                    </form>

                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
}